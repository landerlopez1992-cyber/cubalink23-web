<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ config.app_name }} - Recargas Telefónicas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            color: white;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #16213e;
        }
        .card-stats {
            background-color: #16213e;
            border: 1px solid #0f3460;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: white;
        }
        .nav-link {
            color: white;
            border-radius: 10px;
            margin: 5px 0;
        }
        .nav-link:hover, .nav-link.active {
            background-color: #0f3460;
            color: white;
        }
        .table {
            background-color: #16213e;
            color: white;
        }
        .table th {
            background-color: #0f3460;
            color: white;
            border-color: #0f3460;
        }
        .table td {
            color: white;
            border-color: #0f3460;
        }
        .btn-outline-primary {
            color: white;
            border-color: #0f3460;
        }
        .btn-outline-primary:hover {
            background-color: #0f3460;
            color: white;
        }
        .btn-success {
            background-color: #0f3460;
            border-color: #0f3460;
            color: white;
        }
        .btn-success:hover {
            background-color: #0f3460;
            border-color: #0f3460;
            color: white;
        }
        .btn-primary {
            background-color: #0f3460;
            border-color: #0f3460;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0f3460;
            border-color: #0f3460;
            color: white;
        }
        .modal-content {
            background-color: #16213e;
            color: white;
        }
        .modal-header {
            background-color: #0f3460;
            color: white;
        }
        .modal-footer {
            background-color: #16213e;
            color: white;
        }
        .form-control {
            background-color: #1a1a2e;
            border-color: #16213e;
            color: white;
        }
        .form-control:focus {
            background-color: #1a1a2e;
            border-color: #0f3460;
            color: white;
        }
        .form-select {
            background-color: #1a1a2e;
            border-color: #16213e;
            color: white;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-success {
            background-color: #28a745;
            color: white;
        }
        .status-pending {
            background-color: #ffc107;
            color: black;
        }
        .status-failed {
            background-color: #dc3545;
            color: white;
        }
        .status-insufficient {
            background-color: #fd7e14;
            color: white;
        }
        .search-panel {
            background-color: #16213e;
            border: 1px solid #0f3460;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="text-center mb-4">
                    <img src="/static/img/company-logo.svg" alt="Cubalink23 Logo" style="width: 80px; height: 80px; margin-bottom: 10px;">
                    <h4 class="text-white">{{ config.app_name }}</h4>
                    <small class="text-white-50">Panel de Administración</small>
                </div>
                
                <nav class="nav flex-column">
                    <a class="nav-link" href="/admin/">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="/admin/users">
                        <i class="fas fa-users me-2"></i> Usuarios
                    </a>
                    <a class="nav-link" href="/admin/products">
                        <i class="fas fa-box me-2"></i> Productos
                    </a>
                    <a class="nav-link" href="/admin/orders">
                        <i class="fas fa-shopping-cart me-2"></i> Órdenes
                    </a>
                    <a class="nav-link" href="/admin/flights">
                        <i class="fas fa-plane me-2"></i> Vuelos
                    </a>
                    <a class="nav-link" href="/admin/system">
                        <i class="fas fa-cog me-2"></i> Sistema
                    </a>
                    <a class="nav-link" href="/admin/vendors">
                        <i class="fas fa-store me-2"></i> Vendedores
                    </a>
                    <a class="nav-link" href="/admin/drivers">
                        <i class="fas fa-motorcycle me-2"></i> Repartidores
                    </a>
                    <a class="nav-link" href="/admin/vehicles">
                        <i class="fas fa-car me-2"></i> Renta Car
                    </a>
                    <a class="nav-link active" href="/admin/phone-recharges">
                        <i class="fas fa-mobile-alt me-2"></i> Recargas Telefónicas
                    </a>
                    <a class="nav-link" href="/admin/support-chat">
                        <i class="fas fa-headset me-2"></i> Chat de Soporte
                    </a>
                    <a class="nav-link" href="/admin/alerts">
                        <i class="fas fa-exclamation-triangle me-2"></i> Alertas
                    </a>
                    <a class="nav-link" href="/admin/wallet">
                        <i class="fas fa-wallet me-2"></i> Billetera
                    </a>
                    <a class="nav-link" href="/admin/payment-methods">
                        <i class="fas fa-credit-card me-2"></i> Métodos de Pago
                    </a>
                    <a class="nav-link" href="/admin/payroll">
                        <i class="fas fa-money-bill-wave me-2"></i> Nómina
                    </a>
                    <a class="nav-link mt-4" href="/auth/logout">
                        <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-mobile-alt"></i> Recargas Telefónicas</h2>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="refreshRecharges()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                        <button class="btn btn-success" onclick="showAddBalanceModal()">
                            <i class="fas fa-plus"></i> Agregar Saldo DingConnect
                        </button>
                        <button class="btn btn-primary" onclick="showBalanceModal()">
                            <i class="fas fa-dollar-sign"></i> Ver Saldo
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card card-stats">
                            <div class="card-body text-center">
                                <i class="fas fa-mobile-alt fa-2x text-primary mb-2"></i>
                                <h3 id="total-recharges">-</h3>
                                <p class="mb-0">Recargas Totales</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-stats">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h3 id="successful-recharges">-</h3>
                                <p class="mb-0">Exitosas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-stats">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                <h3 id="pending-recharges">-</h3>
                                <p class="mb-0">Pendientes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-stats">
                            <div class="card-body text-center">
                                <i class="fas fa-dollar-sign fa-2x text-info mb-2"></i>
                                <h3 id="total-amount">-</h3>
                                <p class="mb-0">Monto Total</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Panel -->
                <div class="search-panel">
                    <h5 class="mb-3"><i class="fas fa-search"></i> Buscar Recargas</h5>
                    <form id="searchForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Nombre del Usuario</label>
                                    <input type="text" class="form-control" id="searchName" placeholder="Buscar por nombre...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Teléfono del Usuario</label>
                                    <input type="text" class="form-control" id="searchPhone" placeholder="Buscar por teléfono...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Correo del Usuario</label>
                                    <input type="email" class="form-control" id="searchEmail" placeholder="Buscar por correo...">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Estado</label>
                                    <select class="form-select" id="searchStatus">
                                        <option value="">Todos los estados</option>
                                        <option value="success">✅ Exitosas</option>
                                        <option value="pending">⏳ Pendientes</option>
                                        <option value="failed">❌ Fallidas</option>
                                        <option value="insufficient">⚠️ Saldo Insuficiente</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Fecha Desde</label>
                                    <input type="date" class="form-control" id="searchDateFrom">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Fecha Hasta</label>
                                    <input type="date" class="form-control" id="searchDateTo">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-primary" onclick="searchRecharges()">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                                            <i class="fas fa-times"></i> Limpiar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Recharges Table -->
                <div class="card card-stats">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Historial de Recargas</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Teléfono</th>
                                        <th>Operador</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="recharges-table-body">
                                    <!-- Las recargas se cargarán aquí dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Balance Modal -->
    <div class="modal fade" id="balanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Saldo DingConnect</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <i class="fas fa-dollar-sign fa-3x text-success mb-3"></i>
                        <h3 id="currentBalance">$0.00</h3>
                        <p class="text-muted">Saldo disponible en DingConnect</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Balance Modal -->
    <div class="modal fade" id="addBalanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Saldo a DingConnect</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBalanceForm">
                        <div class="mb-3">
                            <label class="form-label">Monto a Agregar (USD)</label>
                            <input type="number" class="form-control" id="balanceAmount" step="0.01" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Método de Pago</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="">Seleccionar método</option>
                                <option value="credit_card">Tarjeta de Crédito</option>
                                <option value="debit_card">Tarjeta de Débito</option>
                                <option value="bank_transfer">Transferencia Bancaria</option>
                                <option value="paypal">PayPal</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="addBalance()">Agregar Saldo</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let recharges = [];

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadRecharges();
            loadStats();
        });

        // Función para cargar recargas
        function loadRecharges() {
            fetch('/admin/api/phone-recharges')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        recharges = data.recharges;
                        displayRecharges(recharges);
                    } else {
                        showAlert('Error al cargar recargas: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error loading recharges:', error);
                    showAlert('Error al cargar recargas', 'danger');
                });
        }

        // Función para mostrar recargas en la tabla
        function displayRecharges(recharges) {
            const tbody = document.getElementById('recharges-table-body');
            tbody.innerHTML = '';

            recharges.forEach(recharge => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${recharge.user_name}</strong><br>
                        <small class="text-muted">${recharge.user_email || 'Sin email'}</small>
                    </td>
                    <td>${recharge.user_phone}</td>
                    <td>${recharge.operator}</td>
                    <td>$${recharge.amount}</td>
                    <td>
                        <span class="status-badge ${getStatusClass(recharge.status)}">
                            ${getStatusText(recharge.status)}
                        </span>
                    </td>
                    <td>${formatDate(recharge.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewRecharge(${recharge.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${recharge.status === 'failed' ? `
                            <button class="btn btn-sm btn-outline-warning" onclick="reprocessRecharge(${recharge.id})">
                                <i class="fas fa-redo"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRecharge(${recharge.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Función para obtener clase CSS del estado
        function getStatusClass(status) {
            switch(status) {
                case 'success': return 'status-success';
                case 'pending': return 'status-pending';
                case 'failed': return 'status-failed';
                case 'insufficient': return 'status-insufficient';
                default: return 'status-pending';
            }
        }

        // Función para obtener texto del estado
        function getStatusText(status) {
            switch(status) {
                case 'success': return '✅ Exitosa';
                case 'pending': return '⏳ Pendiente';
                case 'failed': return '❌ Fallida';
                case 'insufficient': return '⚠️ Saldo Insuficiente';
                default: return '⏳ Pendiente';
            }
        }

        // Función para formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Función para cargar estadísticas
        function loadStats() {
            const total = recharges.length;
            const successful = recharges.filter(r => r.status === 'success').length;
            const pending = recharges.filter(r => r.status === 'pending').length;
            const totalAmount = recharges.reduce((sum, r) => sum + r.amount, 0);

            document.getElementById('total-recharges').textContent = total;
            document.getElementById('successful-recharges').textContent = successful;
            document.getElementById('pending-recharges').textContent = pending;
            document.getElementById('total-amount').textContent = '$' + totalAmount.toFixed(2);
        }

        // Función para buscar recargas
        function searchRecharges() {
            const searchData = {
                user_name: document.getElementById('searchName').value,
                user_phone: document.getElementById('searchPhone').value,
                user_email: document.getElementById('searchEmail').value,
                status: document.getElementById('searchStatus').value,
                date_from: document.getElementById('searchDateFrom').value,
                date_to: document.getElementById('searchDateTo').value
            };

            fetch('/admin/api/phone-recharges/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(searchData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayRecharges(data.recharges);
                    showAlert('Búsqueda completada', 'info');
                } else {
                    showAlert('Error en la búsqueda: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error en la búsqueda', 'danger');
            });
        }

        // Función para limpiar búsqueda
        function clearSearch() {
            document.getElementById('searchForm').reset();
            loadRecharges();
        }

        // Función para mostrar modal de saldo
        function showBalanceModal() {
            fetch('/admin/api/dingconnect/balance')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('currentBalance').textContent = '$' + data.balance.toFixed(2);
                        new bootstrap.Modal(document.getElementById('balanceModal')).show();
                    } else {
                        showAlert('Error al obtener saldo: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error al obtener saldo', 'danger');
                });
        }

        // Función para mostrar modal de agregar saldo
        function showAddBalanceModal() {
            new bootstrap.Modal(document.getElementById('addBalanceModal')).show();
        }

        // Función para agregar saldo
        function addBalance() {
            const amount = document.getElementById('balanceAmount').value;
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!amount || !paymentMethod) {
                showAlert('Por favor completa todos los campos', 'warning');
                return;
            }

            fetch('/admin/api/dingconnect/add-balance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount: parseFloat(amount),
                    payment_method: paymentMethod
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Saldo agregado exitosamente', 'success');
                    new bootstrap.Modal(document.getElementById('addBalanceModal')).hide();
                    document.getElementById('addBalanceForm').reset();
                } else {
                    showAlert('Error al agregar saldo: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error al agregar saldo', 'danger');
            });
        }

        // Función para reprocesar recarga
        function reprocessRecharge(rechargeId) {
            if (confirm('¿Estás seguro de que quieres reprocesar esta recarga?')) {
                fetch(`/admin/api/phone-recharges/${rechargeId}/reprocess`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Recarga reprocesada exitosamente', 'success');
                        loadRecharges();
                    } else {
                        showAlert('Error al reprocesar: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error al reprocesar recarga', 'danger');
                });
            }
        }

        // Función para eliminar recarga
        function deleteRecharge(rechargeId) {
            if (confirm('¿Estás seguro de que quieres eliminar esta recarga?')) {
                fetch(`/admin/api/phone-recharges/${rechargeId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Recarga eliminada exitosamente', 'success');
                        loadRecharges();
                        loadStats();
                    } else {
                        showAlert('Error al eliminar: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error al eliminar recarga', 'danger');
                });
            }
        }

        // Función para ver detalles de recarga
        function viewRecharge(rechargeId) {
            const recharge = recharges.find(r => r.id === rechargeId);
            if (recharge) {
                alert(`Detalles de la recarga:\n\nUsuario: ${recharge.user_name}\nTeléfono: ${recharge.user_phone}\nOperador: ${recharge.operator}\nMonto: $${recharge.amount}\nEstado: ${getStatusText(recharge.status)}\nFecha: ${formatDate(recharge.created_at)}`);
            }
        }

        // Función para actualizar datos
        function refreshRecharges() {
            loadRecharges();
            loadStats();
            showAlert('Datos actualizados', 'info');
        }

        // Función para mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.col-md-9.col-lg-10');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>

