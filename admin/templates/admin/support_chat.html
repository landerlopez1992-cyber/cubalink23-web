<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Soporte - Panel Administrativo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            color: white;
        }
        .sidebar {
            background-color: #16213e;
            min-height: 100vh;
        }
        .chat-container {
            height: 70vh;
            border: 1px solid #0f3460;
            border-radius: 8px;
            background-color: #16213e;
        }
        .chat-messages {
            height: 60vh;
            overflow-y: auto;
            padding: 1rem;
            background-color: #16213e;
            color: white;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            max-width: 80%;
        }
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        .message.admin {
            background: #28a745;
            color: white;
        }
        .message.vendor {
            background: #ffc107;
            color: black;
        }
        .message.driver {
            background: #17a2b8;
            color: white;
        }
        .chat-input {
            border-top: 1px solid #0f3460;
            padding: 1rem;
            background-color: #16213e;
            color: white;
        }
        .user-list {
            height: 70vh;
            overflow-y: auto;
            border: 1px solid #0f3460;
            border-radius: 8px;
            background-color: #16213e;
            color: white;
        }
        .user-item {
            padding: 0.75rem;
            border-bottom: 1px solid #0f3460;
            cursor: pointer;
            color: white;
        }
        .user-item:hover {
            background-color: #0f3460;
            color: white;
        }
        .user-item.active {
            background: #007bff;
            color: white;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .status-online {
            background: #28a745;
        }
        .status-offline {
            background: #dc3545;
        }
        .status-away {
            background: #ffc107;
        }
        .alert-card {
            border-left: 4px solid #dc3545;
            background-color: #16213e;
            color: white;
        }
        .priority-high {
            border-left-color: #dc3545;
        }
        .priority-medium {
            border-left-color: #ffc107;
        }
        .priority-low {
            border-left-color: #28a745;
        }
        .btn-outline-primary {
            color: white;
            border-color: #0f3460;
        }
        .btn-outline-primary:hover {
            background-color: #0f3460;
            color: white;
        }
        .btn-success {
            background-color: #0f3460;
            border-color: #0f3460;
            color: white;
        }
        .btn-success:hover {
            background-color: #0f3460;
            border-color: #0f3460;
            color: white;
        }
        .nav-link {
            color: white;
        }
        .nav-link.active {
            background-color: #0f3460;
            color: white;
        }
        .form-control {
            background-color: #16213e;
            border-color: #0f3460;
            color: white;
        }
        .form-control:focus {
            background-color: #16213e;
            border-color: #0f3460;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="/static/img/company-logo.svg" alt="Cubalink23 Logo" style="width: 80px; height: 80px; margin-bottom: 10px;">
                        <h4 class="text-white">Cubalink23 Admin</h4>
                        <small class="text-white-50">Panel de Administración</small>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/users">
                                <i class="fas fa-users me-2"></i>
                                Usuarios
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/products">
                                <i class="fas fa-box me-2"></i>
                                Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/orders">
                                <i class="fas fa-shopping-cart me-2"></i>
                                Órdenes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/flights">
                                <i class="fas fa-plane me-2"></i>
                                Vuelos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/system">
                                <i class="fas fa-cog me-2"></i>
                                Sistema
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/vendors">
                                <i class="fas fa-store me-2"></i>
                                Vendedores
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/drivers">
                                <i class="fas fa-truck me-2"></i>
                                Repartidores
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/vehicles">
                                <i class="fas fa-car me-2"></i>
                                Renta Car
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/alerts">
                                <i class="fas fa-bell me-2"></i>
                                Alertas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="/admin/support-chat">
                                <i class="fas fa-comments me-2"></i>
                                Chat Soporte
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/wallet">
                                <i class="fas fa-wallet me-2"></i>
                                Billetera
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/payment-methods">
                                <i class="fas fa-credit-card me-2"></i>
                                Métodos de Pago
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/payroll">
                                <i class="fas fa-money-bill-wave me-2"></i>
                                Nómina
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/system-rules">
                                <i class="fas fa-book me-2"></i>
                                Reglas del Sistema
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link text-danger" href="/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>
                                Cerrar Sesión
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" style="background-color: #1a1a2e;">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2 text-white">
                        <i class="fas fa-comments text-white me-2"></i>
                        Chat de Soporte
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshChat">
                                <i class="fas fa-sync-alt me-1"></i>
                                Actualizar
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="exportChat">
                                <i class="fas fa-download me-1"></i>
                                Exportar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-users fa-2x mb-3 text-primary"></i></h5>
                                <p class="card-text fs-4" id="total-users">0</p>
                                <p class="card-text">Usuarios Activos</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-comments fa-2x mb-3 text-success"></i></h5>
                                <p class="card-text fs-4" id="total-messages">0</p>
                                <p class="card-text">Mensajes Hoy</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-clock fa-2x mb-3 text-warning"></i></h5>
                                <p class="card-text fs-4" id="avg-response">0 min</p>
                                <p class="card-text">Tiempo Respuesta</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-exclamation-triangle fa-2x mb-3 text-danger"></i></h5>
                                <p class="card-text fs-4" id="pending-issues">0</p>
                                <p class="card-text">Problemas Pendientes</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="row">
                    <!-- User List -->
                    <div class="col-md-3">
                        <h5 class="mb-3">
                            <i class="fas fa-users me-2"></i>
                            Usuarios Conectados
                        </h5>
                        <div class="user-list" id="userList">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="col-md-9">
                        <div class="chat-container">
                            <div class="chat-header p-3 bg-light border-bottom">
                                <h6 class="mb-0" id="currentChatUser">
                                    <i class="fas fa-user me-2"></i>
                                    Selecciona un usuario para chatear
                                </h6>
                            </div>
                            <div class="chat-messages" id="chatMessages">
                                <!-- Messages will be loaded here -->
                            </div>
                            <div class="chat-input">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="messageInput" placeholder="Escribe tu mensaje..." disabled>
                                    <button class="btn btn-primary" type="button" id="sendMessage" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Issues -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5 class="mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Problemas Recientes
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Tipo</th>
                                        <th>Problema</th>
                                        <th>Prioridad</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="issuesTable">
                                    <!-- Issues will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- WebSocket Script -->
    <script>
        let ws = null;
        let currentUserId = null;

        // Initialize WebSocket connection
        function initWebSocket() {
            ws = new WebSocket('ws://localhost:5000/ws/support');
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                loadUsers();
                loadStats();
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                setTimeout(initWebSocket, 3000);
            };
        }

        // Handle incoming WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'user_list':
                    updateUserList(data.users);
                    break;
                case 'chat_message':
                    if (data.user_id === currentUserId) {
                        addMessageToChat(data);
                    }
                    break;
                case 'user_status':
                    updateUserStatus(data.user_id, data.status);
                    break;
                case 'stats_update':
                    updateStats(data.stats);
                    break;
            }
        }

        // Load users list
        function loadUsers() {
            fetch('/admin/api/support/users')
                .then(response => response.json())
                .then(data => {
                    updateUserList(data.users);
                })
                .catch(error => console.error('Error loading users:', error));
        }

        // Update user list
        function updateUserList(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-${user.status}"></span>
                        <div>
                            <strong>${user.name}</strong>
                            <br>
                            <small class="text-muted">${user.type}</small>
                        </div>
                    </div>
                `;
                userItem.onclick = () => selectUser(user.id, user.name);
                userList.appendChild(userItem);
            });
        }

        // Select user for chat
        function selectUser(userId, userName) {
            currentUserId = userId;
            document.getElementById('currentChatUser').innerHTML = `<i class="fas fa-user me-2"></i>${userName}`;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendMessage').disabled = false;
            
            // Load chat history
            loadChatHistory(userId);
            
            // Update active user in list
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.user-item').classList.add('active');
        }

        // Load chat history
        function loadChatHistory(userId) {
            fetch(`/admin/api/support/chat/${userId}`)
                .then(response => response.json())
                .then(data => {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    data.messages.forEach(message => {
                        addMessageToChat(message);
                    });
                    
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                })
                .catch(error => console.error('Error loading chat history:', error));
        }

        // Add message to chat
        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender_type}`;
            messageDiv.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${message.sender_name}</strong>
                    <small>${new Date(message.timestamp).toLocaleTimeString()}</small>
                </div>
                <div>${message.content}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        document.getElementById('sendMessage').onclick = function() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message && currentUserId) {
                const messageData = {
                    type: 'chat_message',
                    user_id: currentUserId,
                    content: message,
                    sender_type: 'admin'
                };
                
                ws.send(JSON.stringify(messageData));
                input.value = '';
            }
        };

        // Enter key to send message
        document.getElementById('messageInput').onkeypress = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('sendMessage').click();
            }
        };

        // Load stats
        function loadStats() {
            fetch('/admin/api/support/stats')
                .then(response => response.json())
                .then(data => {
                    updateStats(data);
                })
                .catch(error => console.error('Error loading stats:', error));
        }

        // Update stats
        function updateStats(stats) {
            document.getElementById('total-users').textContent = stats.total_users || 0;
            document.getElementById('total-messages').textContent = stats.total_messages || 0;
            document.getElementById('avg-response').textContent = (stats.avg_response || 0) + ' min';
            document.getElementById('pending-issues').textContent = stats.pending_issues || 0;
        }

        // Load recent issues
        function loadRecentIssues() {
            fetch('/admin/api/support/issues')
                .then(response => response.json())
                .then(data => {
                    updateIssuesTable(data.issues);
                })
                .catch(error => console.error('Error loading issues:', error));
        }

        // Update issues table
        function updateIssuesTable(issues) {
            const tbody = document.getElementById('issuesTable');
            tbody.innerHTML = '';
            
            issues.forEach(issue => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${issue.user_name}</td>
                    <td><span class="badge bg-${getTypeColor(issue.type)}">${issue.type}</span></td>
                    <td>${issue.description}</td>
                    <td><span class="badge bg-${getPriorityColor(issue.priority)}">${issue.priority}</span></td>
                    <td><span class="badge bg-${getStatusColor(issue.status)}">${issue.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="resolveIssue(${issue.id})">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="escalateIssue(${issue.id})">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Helper functions for colors
        function getTypeColor(type) {
            const colors = {
                'delivery': 'warning',
                'payment': 'danger',
                'product': 'info',
                'technical': 'secondary'
            };
            return colors[type] || 'primary';
        }

        function getPriorityColor(priority) {
            const colors = {
                'high': 'danger',
                'medium': 'warning',
                'low': 'success'
            };
            return colors[priority] || 'primary';
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'in_progress': 'info',
                'resolved': 'success',
                'escalated': 'danger'
            };
            return colors[status] || 'primary';
        }

        // Issue actions
        function resolveIssue(issueId) {
            fetch(`/admin/api/support/issues/${issueId}/resolve`, { method: 'POST' })
                .then(() => loadRecentIssues())
                .catch(error => console.error('Error resolving issue:', error));
        }

        function escalateIssue(issueId) {
            fetch(`/admin/api/support/issues/${issueId}/escalate`, { method: 'POST' })
                .then(() => loadRecentIssues())
                .catch(error => console.error('Error escalating issue:', error));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            loadRecentIssues();
            
            // Refresh button
            document.getElementById('refreshChat').onclick = function() {
                loadUsers();
                loadStats();
                loadRecentIssues();
            };
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
